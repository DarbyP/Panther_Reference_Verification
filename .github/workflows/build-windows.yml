name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Create version info file
        run: |
          import re
          
          # Extract version from reference_checker.py
          with open('reference_checker.py', 'r') as f:
              content = f.read()
          match = re.search(r'VERSION = "([^"]+)"', content)
          version = match.group(1) if match else '1.0.0'
          parts = (version.split('.') + ['0', '0', '0', '0'])[:4]
          version_tuple = ', '.join(parts)
          
          version_info = f'''VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=({version_tuple}),
              prodvers=({version_tuple}),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo(
                [
                  StringTable(
                    u'040904B0',
                    [StringStruct(u'CompanyName', u'Darby Proctor, Ph.D.'),
                     StringStruct(u'FileDescription', u'Panther Reference Verification'),
                     StringStruct(u'FileVersion', u'{version}'),
                     StringStruct(u'InternalName', u'ReferenceChecker'),
                     StringStruct(u'LegalCopyright', u'Darby Proctor, Ph.D.'),
                     StringStruct(u'OriginalFilename', u'ReferenceChecker.exe'),
                     StringStruct(u'ProductName', u'Panther Reference Verification'),
                     StringStruct(u'ProductVersion', u'{version}')])
                ]),
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )'''
          
          with open('version_info.txt', 'w') as f:
              f.write(version_info)
          print(f'Created version info for v{version}')
        shell: python

      - name: Build executable
        run: |
          pyinstaller --noconfirm --onefile --windowed --name "ReferenceChecker" --icon "assets/panther_icon.ico" --add-data "assets;assets" --add-data "docs;docs" --version-file "version_info.txt" reference_checker.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReferenceChecker-Windows
          path: dist/ReferenceChecker.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/ReferenceChecker.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
